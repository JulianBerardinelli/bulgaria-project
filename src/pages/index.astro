---
import Layout from '~/layouts/PageLayout.astro';

import Hero from '~/components/widgets/Hero.astro';
import Note from '~/components/widgets/Note.astro';
import Features from '~/components/widgets/Features.astro';
import Features2 from '~/components/widgets/Features2.astro';
import Steps from '~/components/widgets/Steps.astro';
import Content from '~/components/widgets/Content.astro';
import BlogLatestPosts from '~/components/widgets/BlogLatestPosts.astro';
import FAQs from '~/components/widgets/FAQs.astro';
import Stats from '~/components/widgets/Stats.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';

import { getLandingContent } from '~/i18n/landing';
import { DEFAULT_LANGUAGE, isLanguageCode, type LanguageCode } from '~/i18n/config';
import { getBlogPermalink } from '~/utils/permalinks';

const langParam = Astro.url.searchParams.get('lang');
const lang: LanguageCode = isLanguageCode(langParam) ? langParam : DEFAULT_LANGUAGE;
const content = getLandingContent(lang);

const metadata = {
  title: content.metadata.title,
  description: content.metadata.description,
  ignoreTitleTemplate: true,
};

const formatHref = (href: string | undefined) => {
  if (!href) {
    return href;
  }

  if (href.startsWith('http') || href.startsWith('mailto:')) {
    return href;
  }

  if (href.startsWith('#')) {
    const basePath = Astro.url.pathname || '/';
    return `${basePath}${basePath.includes('?') ? '&' : '?'}lang=${lang}${href}`;
  }

  if (href.includes('lang=')) {
    return href;
  }

  const [path, hash] = href.split('#');
  const separator = path.includes('?') ? '&' : '?';
  const pathWithLang = `${path}${separator}lang=${lang}`;
  return hash ? `${pathWithLang}#${hash}` : pathWithLang;
};

const heroActions = content.hero.actions.map((action) => ({
  ...action,
  href: formatHref(action.href),
}));

const callToActionActions = content.callToAction.actions.map((action) => ({
  ...action,
  href: formatHref(action.href),
}));

const blogLinkUrl = formatHref(getBlogPermalink());
---

<Layout metadata={metadata} lang={lang}>
  <!-- Hero Widget ******************* -->

  <Hero actions={heroActions} image={{ src: '~/assets/images/hero-image.png', alt: content.hero.imageAlt }}>
    <Fragment slot="title" set:html={content.hero.titleHtml} />

    <Fragment slot="subtitle" set:html={content.hero.subtitleHtml} />
  </Hero>

  <!-- Note Widget ******************* -->

  <Note title={content.note.title} description={content.note.description} />

  <!-- Features Widget *************** -->

  <Features
    id="features"
    tagline={content.features.tagline}
    title={content.features.title}
    subtitle={content.features.subtitle}
    items={content.features.items}
  />

  <!-- Content Widgets ************** -->

  {content.contentSections.map((section) => (
    <Content
      isReversed={section.isReversed}
      isAfterContent={section.isAfterContent}
      tagline={section.tagline}
      title={section.title}
      items={section.items}
      image={{
        src: section.imageSrc,
        alt: section.imageAlt,
      }}
    >
      <Fragment slot="content" set:html={section.contentHtml} />

      {section.background && (
        <Fragment slot="bg">
          <div class="absolute inset-0 bg-blue-50 dark:bg-transparent"></div>
        </Fragment>
      )}
    </Content>
  ))}

  <!-- Steps Widget ****************** -->

  <Steps
    title={content.steps.title}
    items={content.steps.items}
    image={{
      src: 'https://images.unsplash.com/photo-1616198814651-e71f960c3180?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=987&q=80',
      alt: 'Steps image',
    }}
  />

  <!-- Features2 Widget ************** -->

  <Features2
    title={content.features2.title}
    subtitle={content.features2.subtitle}
    tagline={content.features2.tagline}
    items={content.features2.items}
  >
    <Fragment slot="bg">
      <div class="absolute inset-0 bg-blue-50 dark:bg-transparent"></div>
    </Fragment>
  </Features2>

  <!-- BlogLatestPosts Widget ******** -->

  <BlogLatestPosts
    title={content.blog.title}
    information={content.blog.informationHtml}
    linkText={content.blog.linkText}
    linkUrl={blogLinkUrl}
  />

  <!-- FAQs Widget ******************* -->

  <FAQs
    title={content.faqs.title}
    subtitle={content.faqs.subtitle}
    tagline={content.faqs.tagline}
    classes={{ container: 'max-w-6xl' }}
    items={content.faqs.items}
  />

  <!-- Stats Widget ****************** -->

  <Stats stats={content.stats} />

  <!-- CallToAction Widget *********** -->

  <CallToAction actions={callToActionActions}>
    <Fragment slot="title" set:html={content.callToAction.titleHtml} />

    <Fragment slot="subtitle" set:html={content.callToAction.subtitleHtml} />
  </CallToAction>
</Layout>
